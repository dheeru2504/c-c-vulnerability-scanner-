#include <iostream>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>
#include <cerrno>
#include <cstring>

int main()
{
    const char *filename = "testfile.txt";
    int result;

    // Create a simple file
    int fd = open(filename, O_WRONLY | O_CREAT, 0644);
    if (fd == -1)
    {
        std::cerr << "Failed to create file: " << strerror(errno) << std::endl;
        return 1;
    }
    close(fd);

    // Check file access permission (e.g., write access)
    result = access(filename, W_OK);
    if (result == 0)
    {
        std::cout << "Write access granted. Now attempting to change owner..." << std::endl;

        // Introduce a sleep to simulate delay and increase the chance of race condition
        sleep(5);

        // Attempt to change the owner (e.g., to root or another user)
        // Note: This requires root privileges to succeed
        if (chown(filename, 0, 0) == -1)
        {
            std::cerr << "Failed to change owner: " << strerror(errno) << std::endl;
            return 1;
        }

        std::cout << "Owner changed successfully." << std::endl;
    }
    else
    {
        std::cerr << "No write access: " << strerror(errno) << std::endl;
        return 1;
    }

    return 0;
}
